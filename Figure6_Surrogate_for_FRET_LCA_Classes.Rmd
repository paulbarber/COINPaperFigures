---
title: "Surrogate for FRET LCA Biomarker"
author: "P Barber"
date: "12 April 2019"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

In the tables that shows the patient characteristics for the FRET LCA and full LCA classes some covariates have a significant difference between the classes. KM curves are plotted here to see if these have any predictive value (replicating the LCA class splits).

Load data.

```{r}
load(file = "COIN_Final.Rdata")
```

#Survival Curves split by FRET high vs low, mlivonly and SUMLES, in FRET data set

Exploring whether PIK3CA and FRET split the patients. FRET and SUMLES split by median. 

The patient characteristics table and FRET_Class_Cluster_Means.Rmd/pdf tells us that Class 1 (those who respond to TRT) may be identified.

Try to identify a target Treatment group.

```{r, echo=F}

break_quantile = 0.67

# Use FRET Cohort
data <- patient_data[patient_data$FRET.cohort == 1,]

# Exclude KRAS NRAS BRAF mutant pts as these would not be egfr treated in any case
data <- data[data$RAS == "Wild-type",]
data <- data[data$BRAF == "Wild-type",]

library(survival)
data$SurvObj.pfs <- with(data, Surv(pfstime, pfsevent))
data$SurvObj.os <- with(data, Surv(ostime, osevent))
col=c("red", "red", "blue", "blue") 
lty=c(1, 2)

breaks <- quantile(data$FRET, probs = c(0.0, break_quantile, 1.0), na.rm = T)
data$FRETeff <- cut(data$FRET, breaks = breaks, labels = c("low", "high"), include.lowest = T)

breaks <- quantile(data$SUMLES, probs = c(0.0, break_quantile, 1.0), na.rm = T)
data$SUMLES <- cut(data$SUMLES, breaks = breaks, labels = c("low", "high"), include.lowest = T)

```

##Test individual variables

```{r, echo=F}
km <- survfit(SurvObj.pfs ~ FRETeff + TRT, data=data)
plot(km, col=col, xlab="PFS days", ylab="Prob. survival", lty = lty)
legend("topright", col=col, legend = names(km$strata), lty = lty)

km <- survfit(SurvObj.pfs ~ mlivonly + TRT, data=data)
plot(km, col=col, xlab="PFS days", ylab="Prob. survival", lty = lty)
legend("topright", col=col, legend = names(km$strata), lty = lty)

km <- survfit(SurvObj.pfs ~ SUMLES + TRT, data=data)
plot(km, col=col, xlab="PFS days", ylab="Prob. survival", lty = lty)
legend("topright", col=col, legend = names(km$strata), lty = lty)

```

##Test FRET only

```{r, echo=F}
km <- survfit(SurvObj.pfs ~ FRETeff + TRT, data=data)
print(km)
survdiff(SurvObj.pfs[FRETeff=="low"] ~ TRT[FRETeff=="low"], data=data)
survdiff(SurvObj.pfs[FRETeff=="high"] ~ TRT[FRETeff=="high"], data=data)
```

##Test liver only

```{r, echo=F}
km <- survfit(SurvObj.pfs ~ mlivonly + TRT, data=data)
print(km)
survdiff(SurvObj.pfs[mlivonly=="Yes"] ~ TRT[mlivonly=="Yes"], data=data)
```

##Test SUMLES only

```{r, echo=F}
km <- survfit(SurvObj.pfs ~ SUMLES + TRT, data=data)
print(km)
survdiff(SurvObj.pfs[SUMLES=="low"] ~ TRT[SUMLES=="low"], data=data)
survdiff(SurvObj.pfs[SUMLES=="high"] ~ TRT[SUMLES=="high"], data=data)
```

##Test FRET low + liver only

```{r}
data$treat  <- ifelse(data$FRETeff=="low" & data$mlivonly=="Yes", "Yes", "No")
```

```{r, echo=F}
km <- survfit(SurvObj.pfs ~ treat + TRT, data=data)
plot(km, col=col, xlab="PFS days", ylab="Prob. survival", lty = lty)
legend("topright", col=col, legend = names(km$strata), lty = lty)
print(km)

survdiff(SurvObj.pfs[treat=="Yes"] ~ TRT[treat=="Yes"], data=data)
```

##Test FRET high + liver only

```{r}
data$treat  <- ifelse(data$FRETeff=="high" & data$mlivonly=="Yes", "Yes", "No")
data$treat_os  <- ifelse(data$FRETeff=="high" & data$mlivonly=="Yes", "Yes", "No")
```

```{r, echo=F}
km <- survfit(SurvObj.pfs ~ treat + TRT, data=data)
plot(km, col=col, xlab="PFS days", ylab="Prob. survival", lty = lty)
legend("topright", col=col, legend = names(km$strata), lty = lty)
print(km)

survdiff(SurvObj.pfs[treat=="Yes"] ~ TRT[treat=="Yes"], data=data)

```

##Test SUMLES + liver only

```{r}
data$treat  <- ifelse(data$SUMLES=="low" & data$mlivonly=="Yes", "Yes", "No")
```

```{r, echo=F}
km <- survfit(SurvObj.pfs ~ treat + TRT, data=data)
plot(km, col=col, xlab="PFS days", ylab="Prob. survival", lty = lty)
legend("topright", col=col, legend = names(km$strata), lty = lty)
print(km)

survdiff(SurvObj.pfs[treat=="Yes"] ~ TRT[treat=="Yes"], data=data)

```

##Test FRET + liver only + SUMLES

```{r}
data$treat  <- ifelse(data$FRETeff=="low" &
                            data$mlivonly=="Yes" & data$SUMLES=="low", "Yes", "No")
```

```{r, echo=F}
km <- survfit(SurvObj.pfs ~ treat + TRT, data=data)
plot(km, col=col, xlab="PFS days", ylab="Prob. survival", lty = lty)
legend("topright", col=col, legend = names(km$strata), lty = lty)
print(km)

survdiff(SurvObj.pfs[treat=="Yes"] ~ TRT[treat=="Yes"], data=data)

```

#Overlap with LCA CLasses

Create classes from treat="Yes" -> Class 1.

```{r}
data$treat  <- ifelse(data$FRETeff=="low" & data$mlivonly=="Yes", "Yes", "No")

data$surrogate_class <- ifelse(data$treat=="Yes", 1, 2)

#data$surrogate_class[is.na(data$surrogate_class)] <- 2

as.numeric.factor <- function(x) {as.numeric(levels(x))[x]}
data$Class.FRET.PFS <- as.numeric.factor(data$Class.FRET.PFS)

```

```{r, echo=F}
plot(jitter(data$Class.FRET.PFS) ~ jitter(data$surrogate_class), pch=20, col=rgb(0.1, 0.2, 0.8, 0.3), 
     xaxp=c(1,2,1), yaxp=c(1,2,1), xlab="Surrogate Class", ylab="FRET LCA Class", 
     xlim=c(0.6,2.4), ylim=c(0.6, 2.4))
abline(h=1.5)
abline(v=1.5)

n <- table(data$Class.FRET.PFS, data$surrogate_class)
x <- c(1, 1, 2, 2)
y <- c(1.35, 2.35, 1.35, 2.35)
text(x, y, n)

```

##Cohen's Kappa

```{r}
library(irr)

kappa2(data[,c("Class.FRET.PFS", "surrogate_class")])

```

##Permutations

Calculate the means and standard deviations from 100,000 random group assignments with the same number per subclass as the real data. Also do permutations test and see how many random group are as, or more, extreme as the real data.

```{r, echo=F}
# Calculate the confidence intervals for the random case
library(randomizr)

N = 10000
count_extreme = 0

old1 <- sum(data$Class.FRET.PFS==1, na.rm = T)
old2 <- sum(data$Class.FRET.PFS==2, na.rm = T)
new1 <- sum(data$surrogate_class==1, na.rm = T)
new2 <- sum(data$surrogate_class==2, na.rm = T)
number <- old1 + old2

l <- vector('list', N)
for(i in 1:N){
  # Assign patients to 2 classes in same proportion as FRET OS LCA
  s1 <- complete_ra(N = number, m_each = c(old1, old2))
  # Assign patients to 3 classes in same proportion as Full OS LCA
  s2 <- complete_ra(N = number, m_each = c(new1, new2))
  # Make the confusion matrix
  t <- table(s1, s2)
  l[[i]] <- t
  
  # We hope Class 1 to Class 1 overlap n will be bigger than the random version t
  # Count how many times the other is true
  if (t[1,1] >= n[1,1]) count_extreme = count_extreme + 1
}

arr <- array( unlist(l) , c(2,2,n) )
m <- apply( arr , 1:2 , mean )
s <- apply( arr , 1:2 , sd )
random_ms_text <- paste0(signif(m, 3), "±", signif(s, 3))
random_ms_text <- matrix(random_ms_text, ncol=2, byrow=FALSE)
print("Class number mean and sd.")
print(random_ms_text)

#low <- m - 1.96*s
#high <- m + 1.96*s
#random_ci_text <- paste0("[", signif(low, 3), ",", signif(high, 3), "]")

z <- (as.matrix(n) - m)/(s)
p_values <- 2 * pnorm(-abs(z))
print("p-values.")
print(p_values)

if(count_extreme > 0){
  print(paste("Permutations: ", count_extreme, "/", N, " => p-value =", count_extreme/N))
} else {
  print(paste("Permutations: 0 /", N, " => pvalue <", 1/N))
}
```

#Figure for paper

```{r}
data$treat  <- ifelse(data$FRETeff=="low" & data$mlivonly=="Yes", "Yes", "No")
```

```{r, echo=F}
km <- survfit(SurvObj.pfs ~ treat + TRT, data=data)
plot(km, col=col, xlab="Progression Free Survival (days)", ylab="Probability of Survival", lty = lty)

leg <- names(km$strata)
leg <- sub("treat", "mlivonly + FRET low", leg)

legend("topright", col=col, legend = leg, lty = lty)
print(km)

survdiff(SurvObj.pfs[treat=="Yes"] ~ TRT[treat=="Yes"], data=data)

```

#Session Information

```{r}
sessionInfo()
```


